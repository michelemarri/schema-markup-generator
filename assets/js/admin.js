(()=>{(function(){"use strict";let g={config:{animationDuration:200,toastDuration:3e3,debounceDelay:300},elements:{},init(){this.cacheElements(),this.bindEvents(),this.initComponents(),this.initAnimations()},cacheElements(){this.elements={settingsForm:document.getElementById("smg-settings-form"),tabsNav:document.querySelector(".smg-tabs-nav"),tabContent:document.querySelector(".smg-tab-content"),schemaPreview:document.getElementById("smg-schema-preview"),validationStatus:document.getElementById("smg-validation-status")}},bindEvents(){document.addEventListener("click",e=>{e.target.closest(".smg-toggle-fields")&&this.handleToggleFields(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-schema-select")&&this.handleSchemaTypeChange(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-schema-type-select")&&this.handleMetaBoxSchemaTypeChange(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-field-select")&&this.handleFieldMappingChange(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-toggle-overrides")&&this.handleToggleOverrides(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-override-type-radio")&&this.handleOverrideTypeChange(e)}),document.addEventListener("change",e=>{(e.target.classList.contains("smg-override-select")||e.target.classList.contains("smg-override-input")||e.target.classList.contains("smg-override-textarea"))&&this.handleOverrideValueChange(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-open-preview-modal")&&this.handleOpenPreviewModal(e)}),document.addEventListener("click",e=>{let t=document.getElementById("smg-preview-modal");t&&(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&t.contains(e.target)&&this.closePreviewModal()}),document.addEventListener("click",e=>{e.target.closest(".smg-refresh-preview")&&this.handleRefreshPreview(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-copy-schema")&&this.handleCopySchema(e)}),document.addEventListener("click",e=>{(e.target.id==="smg-test-google"||e.target.closest("#smg-test-google"))&&this.handleGoogleTest(e)}),document.addEventListener("click",e=>{(e.target.id==="smg-validate-schema"||e.target.closest("#smg-validate-schema"))&&this.handleSchemaValidator(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-property-name")&&this.handlePropertyClick(e)}),document.addEventListener("click",e=>{(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&this.closePropertyModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.closePropertyModal()}),this.elements.settingsForm&&this.elements.settingsForm.addEventListener("submit",e=>{this.handleFormSubmit(e)}),document.addEventListener("change",e=>{e.target.closest(".smg-toggle input")&&this.animateToggle(e.target)}),document.addEventListener("click",e=>{e.target.closest(".smg-apply-suggestion")&&this.handleApplySuggestion(e)}),document.addEventListener("keypress",e=>{e.target.classList.contains("smg-pagination-input")&&e.key==="Enter"&&this.handlePaginationInput(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-pagination-input")&&this.handlePaginationInput(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-toggle-password")&&this.handleTogglePassword(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-remove-token")&&this.handleRemoveToken(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-check-updates")&&this.handleCheckUpdates(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-select-logo")&&this.handleSelectLogo(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-remove-logo")&&this.handleRemoveLogo(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-view-example-btn")&&this.handleViewExample(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-copy-example")&&this.handleCopyExample(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-refresh-example")&&this.handleRefreshExample(e)}),document.addEventListener("click",e=>{let t=document.getElementById("smg-example-modal");t&&(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&t.contains(e.target)&&this.closeExampleModal()}),document.addEventListener("click",e=>{e.target.closest(".smg-open-integration-modal")&&this.handleOpenIntegrationModal(e)}),document.addEventListener("click",e=>{let t=e.target.closest(".smg-integration-modal");t&&(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&this.closeIntegrationModal(t)})},initComponents(){this.initPreview(),this.initTooltips(),this.initCollapsibles()},initAnimations(){document.querySelectorAll(".smg-card, .smg-post-type-card, .smg-integration-card, .smg-step").forEach((s,n)=>{s.style.opacity="0",s.style.transform="translateY(10px)",setTimeout(()=>{s.style.transition="opacity 0.3s ease, transform 0.3s ease",s.style.opacity="1",s.style.transform="translateY(0)"},50*n)}),document.querySelectorAll(".smg-schema-item").forEach((s,n)=>{s.style.opacity="0",setTimeout(()=>{s.style.transition="opacity 0.3s ease",s.style.opacity="1"},30*n)}),document.querySelectorAll(".smg-page-row").forEach((s,n)=>{s.style.opacity="0",s.style.transform="translateX(-10px)",setTimeout(()=>{s.style.transition="opacity 0.3s ease, transform 0.3s ease",s.style.opacity="1",s.style.transform="translateX(0)"},30*n)})},handleToggleFields(e){e.preventDefault();let t=e.target.closest(".smg-toggle-fields"),s=t.closest(".smg-post-type-card").querySelector(".smg-post-type-fields"),n=t.getAttribute("aria-expanded")==="true";t.setAttribute("aria-expanded",!n),n?this.slideUp(s):this.slideDown(s)},handlePropertyClick(e){e.preventDefault();let t=e.target.closest(".smg-property-name");if(!t)return;let o=t.dataset.property,s=t.dataset.description,n=t.dataset.example,a=t.dataset.schemaUrl;this.openPropertyModal({name:o,description:s,example:n,schemaUrl:a})},openPropertyModal(e){let t=document.getElementById("smg-property-modal");if(!t)return;let o=t.querySelector(".smg-modal-title"),s=t.querySelector(".smg-modal-description"),n=t.querySelector(".smg-modal-examples"),a=t.querySelector(".smg-examples-list"),i=t.querySelector(".smg-modal-link");if(o&&(o.textContent=e.name||""),s&&(s.textContent=e.description||""),a&&e.example){let r=e.example.split(",").map(l=>l.trim()).filter(l=>l);r.length>0?(a.innerHTML=r.map(l=>`<li><code>${this.escapeHtml(l)}</code></li>`).join(""),n&&(n.style.display="block")):n&&(n.style.display="none")}else n&&(n.style.display="none");i&&(e.schemaUrl?(i.href=e.schemaUrl,i.style.display="inline-flex"):i.style.display="none"),t.style.display="flex",t.offsetHeight,t.classList.add("smg-modal-open"),document.body.style.overflow="hidden"},closePropertyModal(){let e=document.getElementById("smg-property-modal");!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")},escapeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML},async handleSchemaTypeChange(e){let t=e.target,o=t.dataset.postType,s=t.value,n=t.closest(".smg-post-type-card"),a=n.querySelector(".smg-field-mappings");if(a){s?n.classList.add("smg-mapped"):n.classList.remove("smg-mapped"),n.classList.add("smg-saving"),a.style.opacity="0.5",a.innerHTML=`
                <div class="smg-loading-fields">
                    <span class="dashicons dashicons-update smg-spin"></span>
                    ${typeof smgAdmin<"u"&&smgAdmin.strings?.loading?smgAdmin.strings.loading:"Loading..."}
                </div>
            `;try{await this.saveSchemaMapping(o,s);let i=await this.fetchSchemaProperties(o,s);if(i.success&&i.data.html){a.innerHTML=i.data.html,a.style.opacity="1",a.querySelectorAll(".smg-mapping-row").forEach((m,c)=>{m.style.opacity="0",m.style.transform="translateY(10px)",setTimeout(()=>{m.style.transition="opacity 0.3s ease, transform 0.3s ease",m.style.opacity="1",m.style.transform="translateY(0)"},50*c)});let l=n.querySelector(".smg-post-type-fields"),d=n.querySelector(".smg-toggle-fields");l&&l.style.display==="none"&&s&&(this.slideDown(l),d&&d.setAttribute("aria-expanded","true")),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saved?smgAdmin.strings.saved:"Saved","success")}else a.innerHTML=`
                        <p class="smg-notice">
                            <span class="dashicons dashicons-warning"></span>
                            ${i.data?.message||"Failed to load schema properties"}
                        </p>
                    `,a.style.opacity="1"}catch(i){console.error("Failed to save/load schema:",i),a.innerHTML=`
                    <p class="smg-notice">
                        <span class="dashicons dashicons-warning"></span>
                        Failed to save. Please try again.
                    </p>
                `,a.style.opacity="1",this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saveFailed?smgAdmin.strings.saveFailed:"Failed to save","error")}finally{n.classList.remove("smg-saving")}}},async handleFieldMappingChange(e){let t=e.target,s=t.closest(".smg-post-type-card")?.dataset.postType;if(!s)return;let n=t.name.match(/smg_field_mappings\[([^\]]+)\]\[([^\]]+)\]/);if(!n)return;let a=n[2],i=t.value,r=t.closest(".smg-mapping-row, tr");r&&r.classList.add("smg-saving");try{await this.saveFieldMapping(s,a,i),r&&(r.classList.remove("smg-saving"),r.classList.add("smg-saved"),setTimeout(()=>{r.classList.remove("smg-saved")},1500)),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saved?smgAdmin.strings.saved:"Saved","success")}catch(l){console.error("Failed to save field mapping:",l),r&&r.classList.remove("smg-saving"),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saveFailed?smgAdmin.strings.saveFailed:"Failed to save","error")}},saveSchemaMapping(e,t){return new Promise((o,s)=>{let n=new FormData;n.append("action","smg_save_schema_mapping"),n.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),n.append("post_type",e),n.append("schema_type",t),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:n,credentials:"same-origin"}).then(a=>a.json()).then(a=>{a.success?o(a):s(new Error(a.data?.message||"Save failed"))}).catch(a=>s(a))})},saveFieldMapping(e,t,o){return new Promise((s,n)=>{let a=new FormData;a.append("action","smg_save_field_mapping"),a.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),a.append("post_type",e),a.append("property",t),a.append("field_key",o),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:a,credentials:"same-origin"}).then(i=>i.json()).then(i=>{i.success?s(i):n(new Error(i.data?.message||"Save failed"))}).catch(i=>n(i))})},fetchSchemaProperties(e,t){return new Promise((o,s)=>{let n=new FormData;n.append("action","smg_get_schema_properties"),n.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),n.append("post_type",e),n.append("schema_type",t),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:n,credentials:"same-origin"}).then(a=>a.json()).then(a=>o(a)).catch(a=>s(a))})},initPreview(){this.elements.schemaPreview&&typeof smgAdmin<"u"&&this.validateCurrentSchema()},async handleRefreshPreview(e){e.preventDefault();let t=e.target.closest(".smg-refresh-preview"),o=document.querySelector('input[name="smg_post_id"]');if(!o)return;let s=o.value;t.disabled=!0,t.classList.add("loading"),this.elements.schemaPreview.style.opacity="0.5";try{let n=await this.fetchPreview(s);n.success&&(this.elements.schemaPreview.textContent=n.data.json,this.showValidation(n.data.validation),this.elements.schemaPreview.style.transition="opacity 0.3s ease",this.elements.schemaPreview.style.opacity="1")}catch(n){console.error("Preview refresh failed:",n),this.showToast("Failed to refresh preview","error")}finally{t.disabled=!1,t.classList.remove("loading")}},fetchPreview(e){return new Promise((t,o)=>{let s=new FormData;s.append("action","smg_preview_schema"),s.append("nonce",smgAdmin.nonce),s.append("post_id",e),fetch(smgAdmin.ajaxUrl,{method:"POST",body:s,credentials:"same-origin"}).then(n=>n.json()).then(n=>t(n)).catch(n=>o(n))})},async validateCurrentSchema(){let e=document.querySelector('input[name="smg_post_id"]');if(!(!e||!this.elements.schemaPreview))try{let t=await this.fetchPreview(e.value);t.success&&t.data.validation&&this.showValidation(t.data.validation)}catch(t){console.error("Validation failed:",t)}},showValidation(e){if(!e||!this.elements.validationStatus)return;let t="";e.valid?t=`
                    <div class="smg-validation-status valid smg-animate-fade-in">
                        <span class="dashicons dashicons-yes-alt"></span>
                        ${smgAdmin.strings.valid}
                    </div>
                `:t=`
                    <div class="smg-validation-status invalid smg-animate-fade-in">
                        <span class="dashicons dashicons-warning"></span>
                        ${smgAdmin.strings.invalid}
                        ${e.errors&&e.errors.length?`
                            <ul>
                                ${e.errors.map(o=>`<li>${o}</li>`).join("")}
                            </ul>
                        `:""}
                    </div>
                `,e.warnings&&e.warnings.length&&(t+=`
                    <div class="smg-validation-warnings smg-animate-fade-in">
                        <strong>Warnings:</strong>
                        <ul>
                            ${e.warnings.map(o=>`<li>${o}</li>`).join("")}
                        </ul>
                    </div>
                `),this.elements.validationStatus.innerHTML=t},async handleCopySchema(e){e.preventDefault();let t=e.target.closest(".smg-copy-schema"),o=this.elements.schemaPreview?.textContent;if(o)try{await navigator.clipboard.writeText(o);let s=t.innerHTML;t.innerHTML='<span class="dashicons dashicons-yes"></span> '+smgAdmin.strings.copied,t.classList.add("smg-btn-success"),setTimeout(()=>{t.innerHTML=s,t.classList.remove("smg-btn-success")},2e3),this.showToast(smgAdmin.strings.copied,"success")}catch(s){console.error("Copy failed:",s),this.showToast("Failed to copy","error")}},handleGoogleTest(e){e.preventDefault();let o=document.getElementById("smg-test-url")?.value||window.location.origin,s=`https://search.google.com/test/rich-results?url=${encodeURIComponent(o)}`;window.open(s,"_blank","noopener,noreferrer")},handleSchemaValidator(e){e.preventDefault();let o=document.getElementById("smg-validate-url")?.value||window.location.origin,s=`https://validator.schema.org/?url=${encodeURIComponent(o)}`;window.open(s,"_blank","noopener,noreferrer")},handleFormSubmit(e){let t=this.elements.settingsForm.querySelector('[type="submit"]');t&&t.classList.add("loading")},handleApplySuggestion(e){e.preventDefault();let t=e.target.closest(".smg-apply-suggestion"),o=t.dataset.pageId,s=t.dataset.schema,n=document.querySelector(`select[name="smg_page_mappings[${o}]"]`);if(n&&s){n.value=s;let a=t.closest(".smg-page-row");a.style.transition="background-color 0.3s ease",a.style.backgroundColor="var(--smg-success-50)",setTimeout(()=>{a.style.backgroundColor=""},1e3);let i=t.closest(".smg-col-suggestion");i.innerHTML=`
                    <span class="smg-suggestion-applied">
                        <span class="dashicons dashicons-yes-alt"></span>
                    </span>
                `,n.dispatchEvent(new Event("change",{bubbles:!0}))}},handlePaginationInput(e){e.preventDefault();let t=e.target,o=t.dataset.baseUrl,s=parseInt(t.value,10),n=parseInt(t.max,10);s&&s>=1&&s<=n&&o&&(window.location.href=`${o}&paged=${s}`)},handleTogglePassword(e){e.preventDefault();let t=e.target.closest(".smg-toggle-password"),o=t.dataset.target,s=document.getElementById(o),n=t.querySelector(".dashicons");s&&(s.type==="password"?(s.type="text",n.classList.remove("dashicons-visibility"),n.classList.add("dashicons-hidden")):(s.type="password",n.classList.remove("dashicons-hidden"),n.classList.add("dashicons-visibility")))},handleRemoveToken(e){if(e.preventDefault(),!confirm("Are you sure you want to remove the GitHub token?"))return;let t=document.getElementById("smg_github_token");if(t){t.value="";let o=document.querySelector(".smg-token-status");o&&o.remove();let s=document.getElementById("smg-remove-token");s&&(s.style.display="none"),this.showToast("Token will be removed when you save settings","info")}},async handleCheckUpdates(e){e.preventDefault();let t=e.target.closest("#smg-check-updates"),o=document.getElementById("smg-update-result");t.disabled=!0;let s=t.innerHTML;t.innerHTML='<span class="dashicons dashicons-update smg-spin"></span> Checking...',o&&(o.style.display="none");try{let n=new FormData;n.append("action","smg_check_updates"),n.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:"");let i=await(await fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:n,credentials:"same-origin"})).json();o&&(o.style.display="block",i.success?i.data.update_available?(o.className="smg-update-result smg-result-success",o.innerHTML=`
                                <span class="dashicons dashicons-yes-alt"></span>
                                New version available: <strong>${i.data.new_version}</strong>
                                <a href="${i.data.update_url}" class="smg-btn smg-btn-sm smg-btn-primary" style="margin-left: 10px;">Update Now</a>
                            `):(o.className="smg-update-result smg-result-info",o.innerHTML=`
                                <span class="dashicons dashicons-yes"></span>
                                You have the latest version installed.
                            `):(o.className="smg-update-result smg-result-error",o.innerHTML=`
                            <span class="dashicons dashicons-warning"></span>
                            ${i.data?.message||"Could not check for updates."}
                        `))}catch(n){console.error("Update check failed:",n),o&&(o.style.display="block",o.className="smg-update-result smg-result-error",o.innerHTML=`
                        <span class="dashicons dashicons-warning"></span>
                        Failed to check for updates. Please try again.
                    `)}finally{t.disabled=!1,t.innerHTML=s}},animateToggle(e){let t=e.closest(".smg-toggle");t&&(t.style.transform="scale(0.95)",setTimeout(()=>{t.style.transform="scale(1)"},100))},initTooltips(){},initCollapsibles(){document.querySelectorAll(".smg-meta-box-panel-header").forEach(e=>{e.addEventListener("click",()=>{e.closest(".smg-meta-box-panel").classList.toggle("collapsed")})})},slideUp(e){e.style.height=e.scrollHeight+"px",e.offsetHeight,e.style.transition=`height ${this.config.animationDuration}ms ease`,e.style.height="0",e.style.overflow="hidden",setTimeout(()=>{e.style.display="none",e.style.height="",e.style.overflow="",e.style.transition=""},this.config.animationDuration)},slideDown(e){e.style.display="block",e.style.height="0",e.style.overflow="hidden",e.offsetHeight;let t=e.scrollHeight;e.style.transition=`height ${this.config.animationDuration}ms ease`,e.style.height=t+"px",setTimeout(()=>{e.style.height="",e.style.overflow="",e.style.transition=""},this.config.animationDuration)},async handleViewExample(e){e.preventDefault();let t=e.target.closest(".smg-view-example-btn"),o=t.dataset.postType,a=t.closest(".smg-post-type-card")?.querySelector(".smg-schema-select")?.value||"";this.currentExamplePostType=o,this.currentExampleSchemaType=a,await this.loadAndShowExample(o,a)},async loadAndShowExample(e,t){let o=document.getElementById("smg-example-modal");if(!o)return;let s=o.querySelector(".smg-example-schema"),n=o.querySelector(".smg-example-post-title"),a=o.querySelector(".smg-example-edit-link"),i=o.querySelector(".smg-example-view-link"),r=o.querySelector(".smg-example-info");s.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.loading?smgAdmin.strings.loading:"Loading...",n.textContent="",a.style.display="none",i.style.display="none",r.classList.add("smg-loading"),o.style.display="flex",o.offsetHeight,o.classList.add("smg-modal-open"),document.body.style.overflow="hidden";try{let l=await this.fetchRandomExample(e,t);l.success?(s.textContent=l.data.json,n.textContent=l.data.post_title,l.data.edit_url&&(a.href=l.data.edit_url,a.style.display="inline-flex"),l.data.view_url&&(i.href=l.data.view_url,i.style.display="inline-flex")):s.textContent=l.data?.message||"Failed to load example"}catch(l){console.error("Failed to load example:",l),s.textContent="Failed to load example. Please try again."}finally{r.classList.remove("smg-loading")}},fetchRandomExample(e,t){return new Promise((o,s)=>{let n=new FormData;n.append("action","smg_get_random_example"),n.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),n.append("post_type",e),n.append("schema_type",t),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:n,credentials:"same-origin"}).then(a=>a.json()).then(a=>o(a)).catch(a=>s(a))})},async handleCopyExample(e){e.preventDefault();let t=e.target.closest(".smg-copy-example"),s=document.getElementById("smg-example-modal")?.querySelector(".smg-example-schema")?.textContent;if(s)try{await navigator.clipboard.writeText(s);let n=t.innerHTML;t.innerHTML='<span class="dashicons dashicons-yes"></span> '+(typeof smgAdmin<"u"&&smgAdmin.strings?.copied?smgAdmin.strings.copied:"Copied"),t.classList.add("smg-btn-success"),setTimeout(()=>{t.innerHTML=n,t.classList.remove("smg-btn-success")},2e3),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.copied?smgAdmin.strings.copied:"Copied to clipboard","success")}catch(n){console.error("Copy failed:",n),this.showToast("Failed to copy","error")}},async handleRefreshExample(e){e.preventDefault();let t=e.target.closest(".smg-refresh-example");t.disabled=!0;let o=t.innerHTML;t.innerHTML='<span class="dashicons dashicons-update smg-spin"></span>';try{await this.loadAndShowExample(this.currentExamplePostType,this.currentExampleSchemaType)}finally{t.disabled=!1,t.innerHTML=o}},closeExampleModal(){let e=document.getElementById("smg-example-modal");!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")},async handleMetaBoxSchemaTypeChange(e){let t=e.target,o=t.closest(".smg-meta-box");if(!o)return;let s=o.dataset.postId,n=o.dataset.postType,a=t.value;a||(a=(typeof smgAdmin<"u"&&smgAdmin.postTypeMappings?smgAdmin.postTypeMappings:{})[n]||"");let i=document.getElementById("smg_current_schema_type");i&&(i.value=a);let r=o.querySelector(".smg-field-overrides-section");if(r)if(a){r.style.display="";let l=r.querySelector(".smg-field-overrides-container");l&&l.style.display!=="none"&&await this.loadMetaBoxFieldOverrides(s,a,l)}else r.style.display="none"},async handleToggleOverrides(e){e.preventDefault(),console.log("SMG: Toggle overrides clicked");let t=e.target.closest(".smg-toggle-overrides"),s=t.closest(".smg-field-overrides-section").querySelector(".smg-field-overrides-container"),n=t.getAttribute("aria-expanded")==="true",a=t.querySelector(".smg-toggle-text");if(console.log("SMG: isExpanded =",n),t.setAttribute("aria-expanded",!n),n)this.slideUp(s),a&&(a.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.show?smgAdmin.strings.show:"Show");else{this.slideDown(s),a&&(a.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.hide?smgAdmin.strings.hide:"Hide");let i=s.querySelector(".smg-field-overrides-content");if(console.log("SMG: content element",i),console.log("SMG: content.innerHTML.trim()",i?.innerHTML?.trim()),i&&!i.innerHTML.trim()){let r=t.closest(".smg-meta-box"),l=r?.dataset.postId,d=r?.dataset.postType;console.log("SMG: postId =",l,"postType =",d);let m=document.getElementById("smg_current_schema_type")?.value||"";if(console.log("SMG: schemaType from hidden field =",m),!m){let c=document.getElementById("smg_schema_type");console.log("SMG: select element",c,"value",c?.value),c&&!c.value&&(m=typeof smgAdmin<"u"&&smgAdmin.postTypeMappings?.[d]?smgAdmin.postTypeMappings[d]:"",console.log("SMG: schemaType from mappings =",m))}if(console.log("SMG: Final schemaType =",m),l&&m)await this.loadMetaBoxFieldOverrides(l,m,s);else if(l){console.log("SMG: No schema type, showing message"),i.innerHTML='<p class="smg-notice"><span class="dashicons dashicons-info"></span> Select a schema type to configure field overrides.</p>';let c=s.querySelector(".smg-field-overrides-loading");c&&(c.style.display="none")}}else console.log("SMG: Content already loaded or element not found")}},async loadMetaBoxFieldOverrides(e,t,o){console.log("SMG: Loading field overrides",{postId:e,schemaType:t});let s=o.querySelector(".smg-field-overrides-loading"),n=o.querySelector(".smg-field-overrides-content");s&&(s.style.display="flex"),n&&(n.innerHTML="");try{let i=document.querySelector(".smg-meta-box")?.dataset.postType||"post";console.log("SMG: AJAX request params",{postId:e,postType:i,schemaType:t});let r=new FormData;r.append("action","smg_get_metabox_properties"),r.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),r.append("post_id",e),r.append("post_type",i),r.append("schema_type",t);let d=await(await fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:r,credentials:"same-origin"})).json();console.log("SMG: AJAX response",d),d.success&&d.data.html?n&&(n.innerHTML=d.data.html,console.log("SMG: Loaded",n.querySelectorAll(".smg-field-override-row").length,"field rows"),n.querySelectorAll(".smg-field-override-row").forEach((c,p)=>{c.style.opacity="0",c.style.transform="translateY(10px)",setTimeout(()=>{c.style.transition="opacity 0.3s ease, transform 0.3s ease",c.style.opacity="1",c.style.transform="translateY(0)"},30*p)})):(console.warn("SMG: AJAX returned no HTML or error",d),n&&(n.innerHTML=`<p class="smg-notice"><span class="dashicons dashicons-warning"></span> ${d.data?.message||"Failed to load fields"}</p>`))}catch(a){console.error("SMG: Failed to load field overrides:",a),n&&(n.innerHTML='<p class="smg-notice"><span class="dashicons dashicons-warning"></span> Failed to load fields</p>')}finally{s&&(s.style.display="none")}},handleOverrideTypeChange(e){let t=e.target,o=t.closest(".smg-field-override-row"),s=o?.dataset.property,n=t.value;if(!o||!s)return;let a=o.querySelector(".smg-override-field-select"),i=o.querySelector(".smg-override-custom-input");a&&(a.style.display=n==="field"?"":"none"),i&&(i.style.display=n==="custom"?"":"none"),this.updateOverridesJson()},handleOverrideValueChange(e){this.updateOverridesJson()},updateOverridesJson(){let e=document.getElementById("smg_field_overrides_json");if(!e)return;let t={};document.querySelectorAll(".smg-field-override-row").forEach(s=>{let n=s.dataset.property;if(!n)return;let i=s.querySelector(".smg-override-type-radio:checked")?.value||"auto";if(i==="auto")return;let r="";if(i==="field")r=s.querySelector(".smg-override-select")?.value||"";else if(i==="custom"){let l=s.querySelector(".smg-override-input"),d=s.querySelector(".smg-override-textarea");r=l?.value||d?.value||""}r&&(t[n]={type:i,value:r})}),e.value=JSON.stringify(t)},async handleOpenPreviewModal(e){e.preventDefault();let t=document.getElementById("smg-preview-modal");if(!t)return;let s=document.querySelector(".smg-meta-box")?.dataset.postId;if(!s)return;let n=t.querySelector(".smg-schema-preview-modal");n&&(n.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.loading?smgAdmin.strings.loading:"Loading..."),t.style.display="flex",t.offsetHeight,t.classList.add("smg-modal-open"),document.body.style.overflow="hidden";try{let a=await this.fetchPreview(s);a.success&&n&&(n.textContent=a.data.json,a.data.validation&&this.showValidation(a.data.validation))}catch(a){console.error("Failed to load preview:",a),n&&(n.textContent="Failed to load preview")}},closePreviewModal(){let e=document.getElementById("smg-preview-modal");!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")},handleSelectLogo(e){e.preventDefault(),this.logoMediaFrame||(this.logoMediaFrame=wp.media({title:typeof smgAdmin<"u"&&smgAdmin.strings?.selectLogo?smgAdmin.strings.selectLogo:"Select Organization Logo",button:{text:typeof smgAdmin<"u"&&smgAdmin.strings?.useLogo?smgAdmin.strings.useLogo:"Use this logo"},library:{type:"image"},multiple:!1}),this.logoMediaFrame.on("select",()=>{let t=this.logoMediaFrame.state().get("selection").first().toJSON();this.updateLogoPreview(t)})),this.logoMediaFrame.open()},handleRemoveLogo(e){e.preventDefault();let t=document.getElementById("smg-logo-preview"),o=document.getElementById("smg-organization-logo"),s=document.getElementById("smg-remove-logo");t&&(t.innerHTML='<span class="smg-no-image text-gray-400">'+(typeof smgAdmin<"u"&&smgAdmin.strings?.noLogo?smgAdmin.strings.noLogo:"No logo set")+"</span>"),o&&(o.value=""),s&&s.classList.add("hidden"),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.logoRemoved?smgAdmin.strings.logoRemoved:"Logo removed. Save settings to apply.","info")},updateLogoPreview(e){let t=document.getElementById("smg-logo-preview"),o=document.getElementById("smg-organization-logo"),s=document.getElementById("smg-remove-logo");if(t&&e.url){let n=e.sizes?.thumbnail?.url||e.url;t.innerHTML=`<img src="${n}" alt="" class="max-h-16 rounded border border-gray-200">`}o&&(o.value=e.id),s&&s.classList.remove("hidden"),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.logoSelected?smgAdmin.strings.logoSelected:"Logo selected. Save settings to apply.","success")},showToast(e,t="info"){let o=document.createElement("div");o.className=`smg-toast smg-toast-${t} smg-animate-slide-in-right`,o.innerHTML=`
                <span class="dashicons dashicons-${t==="success"?"yes-alt":t==="error"?"warning":"info"}"></span>
                ${e}
            `;let s=document.querySelector(".smg-toast-container");s||(s=document.createElement("div"),s.className="smg-toast-container",s.style.cssText="position: fixed; top: 50px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;",document.body.appendChild(s)),s.appendChild(o),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateX(20px)",setTimeout(()=>o.remove(),300)},this.config.toastDuration)},debounce(e,t){let o;return function(...n){let a=()=>{clearTimeout(o),e(...n)};clearTimeout(o),o=setTimeout(a,t)}},handleOpenIntegrationModal(e){e.preventDefault();let o=e.target.closest(".smg-open-integration-modal")?.dataset.integration;if(!o)return;let s=document.getElementById(`smg-integration-modal-${o}`);s&&(s.style.display="flex",s.offsetHeight,s.classList.add("smg-modal-open"),document.body.style.overflow="hidden")},closeIntegrationModal(e){!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>g.init()):g.init(),window.SMGAdmin=g})();})();
