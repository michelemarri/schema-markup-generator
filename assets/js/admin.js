(()=>{(function(){"use strict";let l={config:{animationDuration:200,toastDuration:3e3,debounceDelay:300},elements:{},init(){this.cacheElements(),this.bindEvents(),this.initComponents(),this.initAnimations()},cacheElements(){this.elements={settingsForm:document.getElementById("smg-settings-form"),tabsNav:document.querySelector(".smg-tabs-nav"),tabContent:document.querySelector(".smg-tab-content"),schemaPreview:document.getElementById("smg-schema-preview"),validationStatus:document.getElementById("smg-validation-status")}},bindEvents(){document.addEventListener("click",e=>{e.target.closest(".smg-toggle-fields")&&this.handleToggleFields(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-schema-select")&&this.handleSchemaTypeChange(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-refresh-preview")&&this.handleRefreshPreview(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-copy-schema")&&this.handleCopySchema(e)}),document.addEventListener("click",e=>{(e.target.id==="smg-test-google"||e.target.closest("#smg-test-google"))&&this.handleGoogleTest(e)}),document.addEventListener("click",e=>{(e.target.id==="smg-validate-schema"||e.target.closest("#smg-validate-schema"))&&this.handleSchemaValidator(e)}),this.elements.settingsForm&&this.elements.settingsForm.addEventListener("submit",e=>{this.handleFormSubmit(e)}),document.addEventListener("change",e=>{e.target.closest(".smg-toggle input")&&this.animateToggle(e.target)}),document.addEventListener("click",e=>{e.target.closest(".smg-apply-suggestion")&&this.handleApplySuggestion(e)}),document.addEventListener("keypress",e=>{e.target.classList.contains("smg-pagination-input")&&e.key==="Enter"&&this.handlePaginationInput(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-pagination-input")&&this.handlePaginationInput(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-toggle-password")&&this.handleTogglePassword(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-remove-token")&&this.handleRemoveToken(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-check-updates")&&this.handleCheckUpdates(e)})},initComponents(){this.initPreview(),this.initTooltips(),this.initCollapsibles()},initAnimations(){document.querySelectorAll(".smg-card, .smg-post-type-card, .smg-integration-card, .smg-step").forEach((t,a)=>{t.style.opacity="0",t.style.transform="translateY(10px)",setTimeout(()=>{t.style.transition="opacity 0.3s ease, transform 0.3s ease",t.style.opacity="1",t.style.transform="translateY(0)"},50*a)}),document.querySelectorAll(".smg-schema-item").forEach((t,a)=>{t.style.opacity="0",setTimeout(()=>{t.style.transition="opacity 0.3s ease",t.style.opacity="1"},30*a)}),document.querySelectorAll(".smg-page-row").forEach((t,a)=>{t.style.opacity="0",t.style.transform="translateX(-10px)",setTimeout(()=>{t.style.transition="opacity 0.3s ease, transform 0.3s ease",t.style.opacity="1",t.style.transform="translateX(0)"},30*a)})},handleToggleFields(e){e.preventDefault();let s=e.target.closest(".smg-toggle-fields"),t=s.closest(".smg-post-type-card").querySelector(".smg-post-type-fields"),a=s.getAttribute("aria-expanded")==="true";s.setAttribute("aria-expanded",!a),a?this.slideUp(t):this.slideDown(t)},async handleSchemaTypeChange(e){let s=e.target,n=s.dataset.postType,t=s.value,a=s.closest(".smg-post-type-card"),i=a.querySelector(".smg-field-mappings");if(i){a.style.transition="border-color 0.3s ease",a.style.borderColor="var(--smg-primary-300)",setTimeout(()=>{a.style.borderColor=""},1e3),i.style.opacity="0.5",i.innerHTML=`
                <div class="smg-loading-fields">
                    <span class="dashicons dashicons-update smg-spin"></span>
                    ${typeof smgAdmin<"u"&&smgAdmin.strings?.loading?smgAdmin.strings.loading:"Loading..."}
                </div>
            `;try{let o=await this.fetchSchemaProperties(n,t);if(o.success&&o.data.html){i.innerHTML=o.data.html,i.style.opacity="1",i.querySelectorAll(".smg-mapping-row").forEach((r,m)=>{r.style.opacity="0",r.style.transform="translateY(10px)",setTimeout(()=>{r.style.transition="opacity 0.3s ease, transform 0.3s ease",r.style.opacity="1",r.style.transform="translateY(0)"},50*m)});let c=a.querySelector(".smg-post-type-fields"),d=a.querySelector(".smg-toggle-fields");c&&c.style.display==="none"&&t&&(this.slideDown(c),d&&d.setAttribute("aria-expanded","true"))}else i.innerHTML=`
                        <p class="smg-notice">
                            <span class="dashicons dashicons-warning"></span>
                            ${o.data?.message||"Failed to load schema properties"}
                        </p>
                    `,i.style.opacity="1"}catch(o){console.error("Failed to load schema properties:",o),i.innerHTML=`
                    <p class="smg-notice">
                        <span class="dashicons dashicons-warning"></span>
                        Failed to load schema properties. Please try again.
                    </p>
                `,i.style.opacity="1"}}},fetchSchemaProperties(e,s){return new Promise((n,t)=>{let a=new FormData;a.append("action","smg_get_schema_properties"),a.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),a.append("post_type",e),a.append("schema_type",s),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:a,credentials:"same-origin"}).then(i=>i.json()).then(i=>n(i)).catch(i=>t(i))})},initPreview(){this.elements.schemaPreview&&typeof smgAdmin<"u"&&this.validateCurrentSchema()},async handleRefreshPreview(e){e.preventDefault();let s=e.target.closest(".smg-refresh-preview"),n=document.querySelector('input[name="smg_post_id"]');if(!n)return;let t=n.value;s.disabled=!0,s.classList.add("loading"),this.elements.schemaPreview.style.opacity="0.5";try{let a=await this.fetchPreview(t);a.success&&(this.elements.schemaPreview.textContent=a.data.json,this.showValidation(a.data.validation),this.elements.schemaPreview.style.transition="opacity 0.3s ease",this.elements.schemaPreview.style.opacity="1")}catch(a){console.error("Preview refresh failed:",a),this.showToast("Failed to refresh preview","error")}finally{s.disabled=!1,s.classList.remove("loading")}},fetchPreview(e){return new Promise((s,n)=>{let t=new FormData;t.append("action","smg_preview_schema"),t.append("nonce",smgAdmin.nonce),t.append("post_id",e),fetch(smgAdmin.ajaxUrl,{method:"POST",body:t,credentials:"same-origin"}).then(a=>a.json()).then(a=>s(a)).catch(a=>n(a))})},async validateCurrentSchema(){let e=document.querySelector('input[name="smg_post_id"]');if(!(!e||!this.elements.schemaPreview))try{let s=await this.fetchPreview(e.value);s.success&&s.data.validation&&this.showValidation(s.data.validation)}catch(s){console.error("Validation failed:",s)}},showValidation(e){if(!e||!this.elements.validationStatus)return;let s="";e.valid?s=`
                    <div class="smg-validation-status valid smg-animate-fade-in">
                        <span class="dashicons dashicons-yes-alt"></span>
                        ${smgAdmin.strings.valid}
                    </div>
                `:s=`
                    <div class="smg-validation-status invalid smg-animate-fade-in">
                        <span class="dashicons dashicons-warning"></span>
                        ${smgAdmin.strings.invalid}
                        ${e.errors&&e.errors.length?`
                            <ul>
                                ${e.errors.map(n=>`<li>${n}</li>`).join("")}
                            </ul>
                        `:""}
                    </div>
                `,e.warnings&&e.warnings.length&&(s+=`
                    <div class="smg-validation-warnings smg-animate-fade-in">
                        <strong>Warnings:</strong>
                        <ul>
                            ${e.warnings.map(n=>`<li>${n}</li>`).join("")}
                        </ul>
                    </div>
                `),this.elements.validationStatus.innerHTML=s},async handleCopySchema(e){e.preventDefault();let s=e.target.closest(".smg-copy-schema"),n=this.elements.schemaPreview?.textContent;if(n)try{await navigator.clipboard.writeText(n);let t=s.innerHTML;s.innerHTML='<span class="dashicons dashicons-yes"></span> '+smgAdmin.strings.copied,s.classList.add("smg-btn-success"),setTimeout(()=>{s.innerHTML=t,s.classList.remove("smg-btn-success")},2e3),this.showToast(smgAdmin.strings.copied,"success")}catch(t){console.error("Copy failed:",t),this.showToast("Failed to copy","error")}},handleGoogleTest(e){e.preventDefault();let n=document.getElementById("smg-test-url")?.value||window.location.origin,t=`https://search.google.com/test/rich-results?url=${encodeURIComponent(n)}`;window.open(t,"_blank","noopener,noreferrer")},handleSchemaValidator(e){e.preventDefault();let n=document.getElementById("smg-validate-url")?.value||window.location.origin,t=`https://validator.schema.org/?url=${encodeURIComponent(n)}`;window.open(t,"_blank","noopener,noreferrer")},handleFormSubmit(e){let s=this.elements.settingsForm.querySelector('[type="submit"]');s&&s.classList.add("loading")},handleApplySuggestion(e){e.preventDefault();let s=e.target.closest(".smg-apply-suggestion"),n=s.dataset.pageId,t=s.dataset.schema,a=document.querySelector(`select[name="smg_page_mappings[${n}]"]`);if(a&&t){a.value=t;let i=s.closest(".smg-page-row");i.style.transition="background-color 0.3s ease",i.style.backgroundColor="var(--smg-success-50)",setTimeout(()=>{i.style.backgroundColor=""},1e3);let o=s.closest(".smg-col-suggestion");o.innerHTML=`
                    <span class="smg-suggestion-applied">
                        <span class="dashicons dashicons-yes-alt"></span>
                    </span>
                `,a.dispatchEvent(new Event("change",{bubbles:!0}))}},handlePaginationInput(e){e.preventDefault();let s=e.target,n=s.dataset.baseUrl,t=parseInt(s.value,10),a=parseInt(s.max,10);t&&t>=1&&t<=a&&n&&(window.location.href=`${n}&paged=${t}`)},handleTogglePassword(e){e.preventDefault();let s=e.target.closest(".smg-toggle-password"),n=s.dataset.target,t=document.getElementById(n),a=s.querySelector(".dashicons");t&&(t.type==="password"?(t.type="text",a.classList.remove("dashicons-visibility"),a.classList.add("dashicons-hidden")):(t.type="password",a.classList.remove("dashicons-hidden"),a.classList.add("dashicons-visibility")))},handleRemoveToken(e){if(e.preventDefault(),!confirm("Are you sure you want to remove the GitHub token?"))return;let s=document.getElementById("smg_github_token");if(s){s.value="";let n=document.querySelector(".smg-token-status");n&&n.remove();let t=document.getElementById("smg-remove-token");t&&(t.style.display="none"),this.showToast("Token will be removed when you save settings","info")}},async handleCheckUpdates(e){e.preventDefault();let s=e.target.closest("#smg-check-updates"),n=document.getElementById("smg-update-result");s.disabled=!0;let t=s.innerHTML;s.innerHTML='<span class="dashicons dashicons-update smg-spin"></span> Checking...',n&&(n.style.display="none");try{let a=new FormData;a.append("action","smg_check_updates"),a.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:"");let o=await(await fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:a,credentials:"same-origin"})).json();n&&(n.style.display="block",o.success?o.data.update_available?(n.className="smg-update-result smg-result-success",n.innerHTML=`
                                <span class="dashicons dashicons-yes-alt"></span>
                                New version available: <strong>${o.data.new_version}</strong>
                                <a href="${o.data.update_url}" class="smg-btn smg-btn-sm smg-btn-primary" style="margin-left: 10px;">Update Now</a>
                            `):(n.className="smg-update-result smg-result-info",n.innerHTML=`
                                <span class="dashicons dashicons-yes"></span>
                                You have the latest version installed.
                            `):(n.className="smg-update-result smg-result-error",n.innerHTML=`
                            <span class="dashicons dashicons-warning"></span>
                            ${o.data?.message||"Could not check for updates."}
                        `))}catch(a){console.error("Update check failed:",a),n&&(n.style.display="block",n.className="smg-update-result smg-result-error",n.innerHTML=`
                        <span class="dashicons dashicons-warning"></span>
                        Failed to check for updates. Please try again.
                    `)}finally{s.disabled=!1,s.innerHTML=t}},animateToggle(e){let s=e.closest(".smg-toggle");s&&(s.style.transform="scale(0.95)",setTimeout(()=>{s.style.transform="scale(1)"},100))},initTooltips(){},initCollapsibles(){document.querySelectorAll(".smg-meta-box-panel-header").forEach(e=>{e.addEventListener("click",()=>{e.closest(".smg-meta-box-panel").classList.toggle("collapsed")})})},slideUp(e){e.style.height=e.scrollHeight+"px",e.offsetHeight,e.style.transition=`height ${this.config.animationDuration}ms ease`,e.style.height="0",e.style.overflow="hidden",setTimeout(()=>{e.style.display="none",e.style.height="",e.style.overflow="",e.style.transition=""},this.config.animationDuration)},slideDown(e){e.style.display="block",e.style.height="0",e.style.overflow="hidden",e.offsetHeight;let s=e.scrollHeight;e.style.transition=`height ${this.config.animationDuration}ms ease`,e.style.height=s+"px",setTimeout(()=>{e.style.height="",e.style.overflow="",e.style.transition=""},this.config.animationDuration)},showToast(e,s="info"){let n=document.createElement("div");n.className=`smg-toast smg-toast-${s} smg-animate-slide-in-right`,n.innerHTML=`
                <span class="dashicons dashicons-${s==="success"?"yes-alt":s==="error"?"warning":"info"}"></span>
                ${e}
            `;let t=document.querySelector(".smg-toast-container");t||(t=document.createElement("div"),t.className="smg-toast-container",t.style.cssText="position: fixed; top: 50px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;",document.body.appendChild(t)),t.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateX(20px)",setTimeout(()=>n.remove(),300)},this.config.toastDuration)},debounce(e,s){let n;return function(...a){let i=()=>{clearTimeout(n),e(...a)};clearTimeout(n),n=setTimeout(i,s)}}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>l.init()):l.init(),window.SMGAdmin=l})();})();
