(()=>{(function(){"use strict";let y={config:{animationDuration:200,toastDuration:3e3,debounceDelay:300},elements:{},init(){this.cacheElements(),this.bindEvents(),this.initComponents(),this.initAnimations()},cacheElements(){this.elements={settingsForm:document.getElementById("smg-settings-form"),tabsNav:document.querySelector(".smg-tabs-nav"),tabContent:document.querySelector(".smg-tab-content"),schemaPreview:document.getElementById("smg-schema-preview"),validationStatus:document.getElementById("smg-validation-status")}},bindEvents(){document.addEventListener("click",e=>{e.target.closest(".smg-toggle-fields")&&this.handleToggleFields(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-schema-select")&&this.handleSchemaTypeChange(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-taxonomy-schema-select")&&this.handleTaxonomySchemaChange(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-schema-type-select")&&this.handleMetaBoxSchemaTypeChange(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-field-select")&&this.handleFieldMappingChange(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-additional-type-select")&&this.handleAdditionalTypeChange(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-toggle-overrides")&&this.handleToggleOverrides(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-override-type-radio")&&this.handleOverrideTypeChange(e)}),document.addEventListener("change",e=>{(e.target.classList.contains("smg-override-select")||e.target.classList.contains("smg-override-input")||e.target.classList.contains("smg-override-textarea"))&&this.handleOverrideValueChange(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-open-preview-modal")&&this.handleOpenPreviewModal(e)}),document.addEventListener("click",e=>{let s=document.getElementById("smg-preview-modal");s&&(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&s.contains(e.target)&&this.closePreviewModal()}),document.addEventListener("click",e=>{e.target.closest(".smg-refresh-preview")&&this.handleRefreshPreview(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-copy-schema")&&this.handleCopySchema(e)}),document.addEventListener("click",e=>{(e.target.id==="smg-test-google"||e.target.closest("#smg-test-google"))&&this.handleGoogleTest(e)}),document.addEventListener("click",e=>{(e.target.id==="smg-validate-schema"||e.target.closest("#smg-validate-schema"))&&this.handleSchemaValidator(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-property-name")&&this.handlePropertyClick(e)}),document.addEventListener("click",e=>{(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&this.closePropertyModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.closePropertyModal()}),this.elements.settingsForm&&this.elements.settingsForm.addEventListener("submit",e=>{this.handleFormSubmit(e)}),document.addEventListener("change",e=>{e.target.closest(".smg-toggle input")&&this.animateToggle(e.target)}),document.addEventListener("click",e=>{e.target.closest(".smg-apply-suggestion")&&this.handleApplySuggestion(e)}),document.addEventListener("keypress",e=>{e.target.classList.contains("smg-pagination-input")&&e.key==="Enter"&&this.handlePaginationInput(e)}),document.addEventListener("change",e=>{e.target.classList.contains("smg-pagination-input")&&this.handlePaginationInput(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-toggle-password")&&this.handleTogglePassword(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-remove-token")&&this.handleRemoveToken(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-check-updates")&&this.handleCheckUpdates(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-select-logo")&&this.handleSelectLogo(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-remove-logo")&&this.handleRemoveLogo(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-view-example-btn")&&this.handleViewExample(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-copy-example")&&this.handleCopyExample(e)}),document.addEventListener("click",e=>{e.target.closest(".smg-refresh-example")&&this.handleRefreshExample(e)}),document.addEventListener("click",e=>{let s=document.getElementById("smg-example-modal");s&&(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&s.contains(e.target)&&this.closeExampleModal()}),document.addEventListener("click",e=>{e.target.closest(".smg-open-integration-modal")&&this.handleOpenIntegrationModal(e)}),document.addEventListener("click",e=>{let s=e.target.closest(".smg-integration-modal");s&&(e.target.closest(".smg-modal-close")||e.target.classList.contains("smg-modal-overlay"))&&this.closeIntegrationModal(s)}),document.addEventListener("click",e=>{e.target.closest("#smg-calculate-durations-btn")&&this.handleCalculateCourseDurations(e)}),document.addEventListener("click",e=>{e.target.closest("#smg-save-youtube-api")&&this.handleSaveYouTubeApiKey(e),e.target.closest("#smg-test-youtube-api")&&this.handleTestYouTubeApiKey(e),e.target.closest("#smg-remove-youtube-api")&&this.handleRemoveYouTubeApiKey(e),e.target.closest("#smg-change-youtube-api")&&this.handleChangeYouTubeApiKey(e)}),document.addEventListener("change",e=>{let s=e.target,a=s.closest(".smg-integration-modal"),n=s.closest(".smg-integration-card");!a&&!n||s.type==="checkbox"&&s.name&&s.name.startsWith("smg_integrations_settings")&&this.handleIntegrationSettingChange(s)})},initComponents(){this.initPreview(),this.initTooltips(),this.initCollapsibles()},initAnimations(){document.querySelectorAll(".smg-card, .smg-post-type-card, .smg-taxonomy-card, .smg-integration-card, .smg-step").forEach((n,t)=>{n.style.opacity="0",n.style.transform="translateY(10px)",setTimeout(()=>{n.style.transition="opacity 0.3s ease, transform 0.3s ease",n.style.opacity="1",n.style.transform="translateY(0)"},50*t)}),document.querySelectorAll(".smg-schema-item").forEach((n,t)=>{n.style.opacity="0",setTimeout(()=>{n.style.transition="opacity 0.3s ease",n.style.opacity="1"},30*t)}),document.querySelectorAll(".smg-page-row").forEach((n,t)=>{n.style.opacity="0",n.style.transform="translateX(-10px)",setTimeout(()=>{n.style.transition="opacity 0.3s ease, transform 0.3s ease",n.style.opacity="1",n.style.transform="translateX(0)"},30*t)})},handleToggleFields(e){e.preventDefault();let s=e.target.closest(".smg-toggle-fields"),n=s.closest(".smg-post-type-card").querySelector(".smg-post-type-fields"),t=s.getAttribute("aria-expanded")==="true";s.setAttribute("aria-expanded",!t),t?this.slideUp(n):this.slideDown(n)},handlePropertyClick(e){e.preventDefault();let s=e.target.closest(".smg-property-name");if(!s)return;let a=s.dataset.property,n=s.dataset.description,t=s.dataset.example,o=s.dataset.schemaUrl;this.openPropertyModal({name:a,description:n,example:t,schemaUrl:o})},openPropertyModal(e){let s=document.getElementById("smg-property-modal");if(!s)return;let a=s.querySelector(".smg-modal-title"),n=s.querySelector(".smg-modal-description"),t=s.querySelector(".smg-modal-examples"),o=s.querySelector(".smg-examples-list"),i=s.querySelector(".smg-modal-link");if(a&&(a.textContent=e.name||""),n&&(n.textContent=e.description||""),o&&e.example){let r=e.example.split(",").map(d=>d.trim()).filter(d=>d);r.length>0?(o.innerHTML=r.map(d=>`<li><code>${this.escapeHtml(d)}</code></li>`).join(""),t&&(t.style.display="block")):t&&(t.style.display="none")}else t&&(t.style.display="none");i&&(e.schemaUrl?(i.href=e.schemaUrl,i.style.display="inline-flex"):i.style.display="none"),s.style.display="flex",s.offsetHeight,s.classList.add("smg-modal-open"),document.body.style.overflow="hidden"},closePropertyModal(){let e=document.getElementById("smg-property-modal");!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")},escapeHtml(e){let s=document.createElement("div");return s.textContent=e,s.innerHTML},async handleSchemaTypeChange(e){let s=e.target,a=s.dataset.postType,n=s.value,t=s.closest(".smg-post-type-card"),o=t.querySelector(".smg-field-mappings");if(o){n?t.classList.add("smg-mapped"):t.classList.remove("smg-mapped"),t.classList.add("smg-saving"),o.style.opacity="0.5",o.innerHTML=`
                <div class="smg-loading-fields">
                    <span class="dashicons dashicons-update smg-spin"></span>
                    ${typeof smgAdmin<"u"&&smgAdmin.strings?.loading?smgAdmin.strings.loading:"Loading..."}
                </div>
            `;try{await this.saveSchemaMapping(a,n);let i=await this.fetchSchemaProperties(a,n);if(i.success&&i.data.html){o.innerHTML=i.data.html,o.style.opacity="1",o.querySelectorAll(".smg-mapping-row").forEach((c,m)=>{c.style.opacity="0",c.style.transform="translateY(10px)",setTimeout(()=>{c.style.transition="opacity 0.3s ease, transform 0.3s ease",c.style.opacity="1",c.style.transform="translateY(0)"},50*m)});let d=t.querySelector(".smg-post-type-fields"),l=t.querySelector(".smg-toggle-fields");d&&d.style.display==="none"&&n&&(this.slideDown(d),l&&l.setAttribute("aria-expanded","true")),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saved?smgAdmin.strings.saved:"Saved","success")}else o.innerHTML=`
                        <p class="smg-notice">
                            <span class="dashicons dashicons-warning"></span>
                            ${i.data?.message||"Failed to load schema properties"}
                        </p>
                    `,o.style.opacity="1"}catch(i){console.error("Failed to save/load schema:",i),o.innerHTML=`
                    <p class="smg-notice">
                        <span class="dashicons dashicons-warning"></span>
                        Failed to save. Please try again.
                    </p>
                `,o.style.opacity="1",this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saveFailed?smgAdmin.strings.saveFailed:"Failed to save","error")}finally{t.classList.remove("smg-saving")}}},async handleFieldMappingChange(e){let s=e.target,n=s.closest(".smg-post-type-card")?.dataset.postType;if(!n)return;let t=s.name.match(/smg_field_mappings\[([^\]]+)\]\[([^\]]+)\]/);if(!t)return;let o=t[2],i=s.value,r=s.closest(".smg-mapping-row, tr");r&&r.classList.add("smg-saving");try{await this.saveFieldMapping(n,o,i),r&&(r.classList.remove("smg-saving"),r.classList.add("smg-saved"),setTimeout(()=>{r.classList.remove("smg-saved")},1500)),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saved?smgAdmin.strings.saved:"Saved","success")}catch(d){console.error("Failed to save field mapping:",d),r&&r.classList.remove("smg-saving"),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saveFailed?smgAdmin.strings.saveFailed:"Failed to save","error")}},async handleAdditionalTypeChange(e){let s=e.target,n=s.closest(".smg-post-type-card")?.dataset.postType||s.dataset.postType;if(!n)return;let t=s.value;try{await this.saveFieldMapping(n,"additionalType",t),s.classList.add("smg-saved"),setTimeout(()=>{s.classList.remove("smg-saved")},1500),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saved?smgAdmin.strings.saved:"Saved","success")}catch(o){console.error("Failed to save additional type:",o),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saveFailed?smgAdmin.strings.saveFailed:"Failed to save","error")}},async handleTaxonomySchemaChange(e){let s=e.target,a=s.dataset.taxonomy,n=s.value,t=s.closest(".smg-taxonomy-card");if(t){n?t.classList.add("smg-mapped"):t.classList.remove("smg-mapped"),t.classList.add("smg-saving");try{await this.saveTaxonomySchemaMapping(a,n);let o=t.querySelector(".smg-taxonomy-schema-info");if(n)if(o)o.innerHTML=`
                            <span class="smg-schema-badge">
                                <span class="dashicons dashicons-yes-alt"></span>
                                ${this.escapeHtml(n)}
                            </span>
                            <span class="smg-schema-hint">
                                ${typeof smgAdmin<"u"&&smgAdmin.strings?.schemaOnArchive?smgAdmin.strings.schemaOnArchive:"Schema will be rendered on taxonomy archive pages"}
                            </span>
                        `,o.style.display="";else{let i=t.querySelector(".smg-taxonomy-header");if(i){let r=document.createElement("div");r.className="smg-taxonomy-schema-info",r.innerHTML=`
                                <span class="smg-schema-badge">
                                    <span class="dashicons dashicons-yes-alt"></span>
                                    ${this.escapeHtml(n)}
                                </span>
                                <span class="smg-schema-hint">
                                    ${typeof smgAdmin<"u"&&smgAdmin.strings?.schemaOnArchive?smgAdmin.strings.schemaOnArchive:"Schema will be rendered on taxonomy archive pages"}
                                </span>
                            `,i.after(r)}}else o&&(o.style.display="none");this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saved?smgAdmin.strings.saved:"Saved","success")}catch(o){console.error("Failed to save taxonomy schema:",o),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saveFailed?smgAdmin.strings.saveFailed:"Failed to save","error")}finally{t.classList.remove("smg-saving")}}},saveTaxonomySchemaMapping(e,s){return new Promise((a,n)=>{let t=new FormData;t.append("action","smg_save_taxonomy_mapping"),t.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),t.append("taxonomy",e),t.append("schema_type",s),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:t,credentials:"same-origin"}).then(o=>o.json()).then(o=>{o.success?a(o):n(new Error(o.data?.message||"Save failed"))}).catch(o=>n(o))})},saveSchemaMapping(e,s){return new Promise((a,n)=>{let t=new FormData;t.append("action","smg_save_schema_mapping"),t.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),t.append("post_type",e),t.append("schema_type",s),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:t,credentials:"same-origin"}).then(o=>o.json()).then(o=>{o.success?a(o):n(new Error(o.data?.message||"Save failed"))}).catch(o=>n(o))})},saveFieldMapping(e,s,a){return new Promise((n,t)=>{let o=new FormData;o.append("action","smg_save_field_mapping"),o.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),o.append("post_type",e),o.append("property",s),o.append("field_key",a),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:o,credentials:"same-origin"}).then(i=>i.json()).then(i=>{i.success?n(i):t(new Error(i.data?.message||"Save failed"))}).catch(i=>t(i))})},fetchSchemaProperties(e,s){return new Promise((a,n)=>{let t=new FormData;t.append("action","smg_get_schema_properties"),t.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),t.append("post_type",e),t.append("schema_type",s),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:t,credentials:"same-origin"}).then(o=>o.json()).then(o=>a(o)).catch(o=>n(o))})},initPreview(){this.elements.schemaPreview&&typeof smgAdmin<"u"&&this.validateCurrentSchema()},async handleRefreshPreview(e){e.preventDefault();let s=e.target.closest(".smg-refresh-preview"),a=document.querySelector('input[name="smg_post_id"]');if(!a)return;let n=a.value;s.disabled=!0,s.classList.add("loading"),this.elements.schemaPreview.style.opacity="0.5";try{let t=await this.fetchPreview(n);t.success&&(this.elements.schemaPreview.textContent=t.data.json,this.showValidation(t.data.validation),this.elements.schemaPreview.style.transition="opacity 0.3s ease",this.elements.schemaPreview.style.opacity="1")}catch(t){console.error("Preview refresh failed:",t),this.showToast("Failed to refresh preview","error")}finally{s.disabled=!1,s.classList.remove("loading")}},fetchPreview(e){return new Promise((s,a)=>{let n=new FormData;n.append("action","smg_preview_schema"),n.append("nonce",smgAdmin.nonce),n.append("post_id",e),fetch(smgAdmin.ajaxUrl,{method:"POST",body:n,credentials:"same-origin"}).then(t=>t.json()).then(t=>s(t)).catch(t=>a(t))})},async validateCurrentSchema(){let e=document.querySelector('input[name="smg_post_id"]');if(!(!e||!this.elements.schemaPreview))try{let s=await this.fetchPreview(e.value);s.success&&s.data.validation&&this.showValidation(s.data.validation)}catch(s){console.error("Validation failed:",s)}},showValidation(e){if(!e||!this.elements.validationStatus)return;let s="";e.valid?s=`
                    <div class="smg-validation-status valid smg-animate-fade-in">
                        <span class="dashicons dashicons-yes-alt"></span>
                        ${smgAdmin.strings.valid}
                    </div>
                `:s=`
                    <div class="smg-validation-status invalid smg-animate-fade-in">
                        <span class="dashicons dashicons-warning"></span>
                        ${smgAdmin.strings.invalid}
                        ${e.errors&&e.errors.length?`
                            <ul>
                                ${e.errors.map(a=>`<li>${a}</li>`).join("")}
                            </ul>
                        `:""}
                    </div>
                `,e.warnings&&e.warnings.length&&(s+=`
                    <div class="smg-validation-warnings smg-animate-fade-in">
                        <strong>Warnings:</strong>
                        <ul>
                            ${e.warnings.map(a=>`<li>${a}</li>`).join("")}
                        </ul>
                    </div>
                `),this.elements.validationStatus.innerHTML=s},async handleCopySchema(e){e.preventDefault();let s=e.target.closest(".smg-copy-schema"),a=this.elements.schemaPreview?.textContent;if(a)try{await navigator.clipboard.writeText(a);let n=s.innerHTML;s.innerHTML='<span class="dashicons dashicons-yes"></span> '+smgAdmin.strings.copied,s.classList.add("smg-btn-success"),setTimeout(()=>{s.innerHTML=n,s.classList.remove("smg-btn-success")},2e3),this.showToast(smgAdmin.strings.copied,"success")}catch(n){console.error("Copy failed:",n),this.showToast("Failed to copy","error")}},handleGoogleTest(e){e.preventDefault();let a=document.getElementById("smg-test-url")?.value||window.location.origin,n=`https://search.google.com/test/rich-results?url=${encodeURIComponent(a)}`;window.open(n,"_blank","noopener,noreferrer")},handleSchemaValidator(e){e.preventDefault();let a=document.getElementById("smg-validate-url")?.value||window.location.origin,n=`https://validator.schema.org/?url=${encodeURIComponent(a)}`;window.open(n,"_blank","noopener,noreferrer")},handleFormSubmit(e){let s=this.elements.settingsForm.querySelector('[type="submit"]');s&&s.classList.add("loading")},handleApplySuggestion(e){e.preventDefault();let s=e.target.closest(".smg-apply-suggestion"),a=s.dataset.pageId,n=s.dataset.schema,t=document.querySelector(`select[name="smg_page_mappings[${a}]"]`);if(t&&n){t.value=n;let o=s.closest(".smg-page-row");o.style.transition="background-color 0.3s ease",o.style.backgroundColor="var(--smg-success-50)",setTimeout(()=>{o.style.backgroundColor=""},1e3);let i=s.closest(".smg-col-suggestion");i.innerHTML=`
                    <span class="smg-suggestion-applied">
                        <span class="dashicons dashicons-yes-alt"></span>
                    </span>
                `,t.dispatchEvent(new Event("change",{bubbles:!0}))}},handlePaginationInput(e){e.preventDefault();let s=e.target,a=s.dataset.baseUrl,n=parseInt(s.value,10),t=parseInt(s.max,10);n&&n>=1&&n<=t&&a&&(window.location.href=`${a}&paged=${n}`)},handleTogglePassword(e){e.preventDefault();let s=e.target.closest(".smg-toggle-password"),a=s.dataset.target,n=document.getElementById(a),t=s.querySelector(".dashicons");n&&(n.type==="password"?(n.type="text",t.classList.remove("dashicons-visibility"),t.classList.add("dashicons-hidden")):(n.type="password",t.classList.remove("dashicons-hidden"),t.classList.add("dashicons-visibility")))},handleRemoveToken(e){if(e.preventDefault(),!confirm("Are you sure you want to remove the GitHub token?"))return;let s=document.getElementById("smg_github_token");if(s){s.value="";let a=document.querySelector(".smg-token-status");a&&a.remove();let n=document.getElementById("smg-remove-token");n&&(n.style.display="none"),this.showToast("Token will be removed when you save settings","info")}},async handleCheckUpdates(e){e.preventDefault();let s=e.target.closest("#smg-check-updates"),a=document.getElementById("smg-update-result");s.disabled=!0;let n=s.innerHTML;s.innerHTML='<span class="dashicons dashicons-update smg-spin"></span> Checking...',a&&(a.style.display="none");try{let t=new FormData;t.append("action","smg_check_updates"),t.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:"");let i=await(await fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:t,credentials:"same-origin"})).json();a&&(a.style.display="block",i.success?i.data.update_available?(a.className="smg-update-result smg-result-success",a.innerHTML=`
                                <span class="dashicons dashicons-yes-alt"></span>
                                New version available: <strong>${i.data.new_version}</strong>
                                <a href="${i.data.update_url}" class="smg-btn smg-btn-sm smg-btn-primary" style="margin-left: 10px;">Update Now</a>
                            `):(a.className="smg-update-result smg-result-info",a.innerHTML=`
                                <span class="dashicons dashicons-yes"></span>
                                You have the latest version installed.
                            `):(a.className="smg-update-result smg-result-error",a.innerHTML=`
                            <span class="dashicons dashicons-warning"></span>
                            ${i.data?.message||"Could not check for updates."}
                        `))}catch(t){console.error("Update check failed:",t),a&&(a.style.display="block",a.className="smg-update-result smg-result-error",a.innerHTML=`
                        <span class="dashicons dashicons-warning"></span>
                        Failed to check for updates. Please try again.
                    `)}finally{s.disabled=!1,s.innerHTML=n}},animateToggle(e){let s=e.closest(".smg-toggle");s&&(s.style.transform="scale(0.95)",setTimeout(()=>{s.style.transform="scale(1)"},100))},initTooltips(){},initCollapsibles(){document.querySelectorAll(".smg-meta-box-panel-header").forEach(e=>{e.addEventListener("click",()=>{e.closest(".smg-meta-box-panel").classList.toggle("collapsed")})})},slideUp(e){e.style.height=e.scrollHeight+"px",e.offsetHeight,e.style.transition=`height ${this.config.animationDuration}ms ease`,e.style.height="0",e.style.overflow="hidden",setTimeout(()=>{e.style.display="none",e.style.height="",e.style.overflow="",e.style.transition=""},this.config.animationDuration)},slideDown(e){e.style.display="block",e.style.height="0",e.style.overflow="hidden",e.offsetHeight;let s=e.scrollHeight;e.style.transition=`height ${this.config.animationDuration}ms ease`,e.style.height=s+"px",setTimeout(()=>{e.style.height="",e.style.overflow="",e.style.transition=""},this.config.animationDuration)},async handleViewExample(e){e.preventDefault();let s=e.target.closest(".smg-view-example-btn"),a=s.dataset.postType,o=s.closest(".smg-post-type-card")?.querySelector(".smg-schema-select")?.value||"";this.currentExamplePostType=a,this.currentExampleSchemaType=o,await this.loadAndShowExample(a,o)},async loadAndShowExample(e,s){let a=document.getElementById("smg-example-modal");if(!a)return;let n=a.querySelector(".smg-example-schema"),t=a.querySelector(".smg-example-post-title"),o=a.querySelector(".smg-example-edit-link"),i=a.querySelector(".smg-example-view-link"),r=a.querySelector(".smg-example-info");n.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.loading?smgAdmin.strings.loading:"Loading...",t.textContent="",o.style.display="none",i.style.display="none",r.classList.add("smg-loading"),a.style.display="flex",a.offsetHeight,a.classList.add("smg-modal-open"),document.body.style.overflow="hidden";try{let d=await this.fetchRandomExample(e,s);d.success?(n.textContent=d.data.json,t.textContent=d.data.post_title,d.data.edit_url&&(o.href=d.data.edit_url,o.style.display="inline-flex"),d.data.view_url&&(i.href=d.data.view_url,i.style.display="inline-flex")):n.textContent=d.data?.message||"Failed to load example"}catch(d){console.error("Failed to load example:",d),n.textContent="Failed to load example. Please try again."}finally{r.classList.remove("smg-loading")}},fetchRandomExample(e,s){return new Promise((a,n)=>{let t=new FormData;t.append("action","smg_get_random_example"),t.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),t.append("post_type",e),t.append("schema_type",s),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:t,credentials:"same-origin"}).then(o=>o.json()).then(o=>a(o)).catch(o=>n(o))})},async handleCopyExample(e){e.preventDefault();let s=e.target.closest(".smg-copy-example"),n=document.getElementById("smg-example-modal")?.querySelector(".smg-example-schema")?.textContent;if(n)try{await navigator.clipboard.writeText(n);let t=s.innerHTML;s.innerHTML='<span class="dashicons dashicons-yes"></span> '+(typeof smgAdmin<"u"&&smgAdmin.strings?.copied?smgAdmin.strings.copied:"Copied"),s.classList.add("smg-btn-success"),setTimeout(()=>{s.innerHTML=t,s.classList.remove("smg-btn-success")},2e3),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.copied?smgAdmin.strings.copied:"Copied to clipboard","success")}catch(t){console.error("Copy failed:",t),this.showToast("Failed to copy","error")}},async handleRefreshExample(e){e.preventDefault();let s=e.target.closest(".smg-refresh-example");s.disabled=!0;let a=s.innerHTML;s.innerHTML='<span class="dashicons dashicons-update smg-spin"></span>';try{await this.loadAndShowExample(this.currentExamplePostType,this.currentExampleSchemaType)}finally{s.disabled=!1,s.innerHTML=a}},closeExampleModal(){let e=document.getElementById("smg-example-modal");!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")},async handleMetaBoxSchemaTypeChange(e){let s=e.target,a=s.closest(".smg-meta-box");if(!a)return;let n=a.dataset.postId,t=a.dataset.postType,o=s.value;o||(o=(typeof smgAdmin<"u"&&smgAdmin.postTypeMappings?smgAdmin.postTypeMappings:{})[t]||"");let i=document.getElementById("smg_current_schema_type");i&&(i.value=o);let r=a.querySelector(".smg-field-overrides-section");if(r)if(o){r.style.display="";let d=r.querySelector(".smg-field-overrides-container");d&&d.style.display!=="none"&&await this.loadMetaBoxFieldOverrides(n,o,d)}else r.style.display="none"},async handleToggleOverrides(e){e.preventDefault(),console.log("SMG: Toggle overrides clicked");let s=e.target.closest(".smg-toggle-overrides"),n=s.closest(".smg-field-overrides-section").querySelector(".smg-field-overrides-container"),t=s.getAttribute("aria-expanded")==="true",o=s.querySelector(".smg-toggle-text");if(console.log("SMG: isExpanded =",t),s.setAttribute("aria-expanded",!t),t)this.slideUp(n),o&&(o.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.show?smgAdmin.strings.show:"Show");else{this.slideDown(n),o&&(o.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.hide?smgAdmin.strings.hide:"Hide");let i=n.querySelector(".smg-field-overrides-content");if(console.log("SMG: content element",i),console.log("SMG: content.innerHTML.trim()",i?.innerHTML?.trim()),i&&!i.innerHTML.trim()){let r=s.closest(".smg-meta-box"),d=r?.dataset.postId,l=r?.dataset.postType;console.log("SMG: postId =",d,"postType =",l);let c=document.getElementById("smg_current_schema_type")?.value||"";if(console.log("SMG: schemaType from hidden field =",c),!c){let m=document.getElementById("smg_schema_type");console.log("SMG: select element",m,"value",m?.value),m&&!m.value&&(c=typeof smgAdmin<"u"&&smgAdmin.postTypeMappings?.[l]?smgAdmin.postTypeMappings[l]:"",console.log("SMG: schemaType from mappings =",c))}if(console.log("SMG: Final schemaType =",c),d&&c)await this.loadMetaBoxFieldOverrides(d,c,n);else if(d){console.log("SMG: No schema type, showing message"),i.innerHTML='<p class="smg-notice"><span class="dashicons dashicons-info"></span> Select a schema type to configure field overrides.</p>';let m=n.querySelector(".smg-field-overrides-loading");m&&(m.style.display="none")}}else console.log("SMG: Content already loaded or element not found")}},async loadMetaBoxFieldOverrides(e,s,a){console.log("SMG: Loading field overrides",{postId:e,schemaType:s});let n=a.querySelector(".smg-field-overrides-loading"),t=a.querySelector(".smg-field-overrides-content");n&&(n.style.display="flex"),t&&(t.innerHTML="");try{let i=document.querySelector(".smg-meta-box")?.dataset.postType||"post";console.log("SMG: AJAX request params",{postId:e,postType:i,schemaType:s});let r=new FormData;r.append("action","smg_get_metabox_properties"),r.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),r.append("post_id",e),r.append("post_type",i),r.append("schema_type",s);let l=await(await fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:r,credentials:"same-origin"})).json();console.log("SMG: AJAX response",l),l.success&&l.data.html?t&&(t.innerHTML=l.data.html,console.log("SMG: Loaded",t.querySelectorAll(".smg-field-override-row").length,"field rows"),t.querySelectorAll(".smg-field-override-row").forEach((m,h)=>{m.style.opacity="0",m.style.transform="translateY(10px)",setTimeout(()=>{m.style.transition="opacity 0.3s ease, transform 0.3s ease",m.style.opacity="1",m.style.transform="translateY(0)"},30*h)})):(console.warn("SMG: AJAX returned no HTML or error",l),t&&(t.innerHTML=`<p class="smg-notice"><span class="dashicons dashicons-warning"></span> ${l.data?.message||"Failed to load fields"}</p>`))}catch(o){console.error("SMG: Failed to load field overrides:",o),t&&(t.innerHTML='<p class="smg-notice"><span class="dashicons dashicons-warning"></span> Failed to load fields</p>')}finally{n&&(n.style.display="none")}},handleOverrideTypeChange(e){let s=e.target,a=s.closest(".smg-field-override-row"),n=a?.dataset.property,t=s.value;if(!a||!n)return;let o=a.querySelector(".smg-override-field-select"),i=a.querySelector(".smg-override-custom-input");o&&(o.style.display=t==="field"?"":"none"),i&&(i.style.display=t==="custom"?"":"none"),this.updateOverridesJson()},handleOverrideValueChange(e){this.updateOverridesJson()},updateOverridesJson(){let e=document.getElementById("smg_field_overrides_json");if(!e)return;let s={};document.querySelectorAll(".smg-field-override-row").forEach(n=>{let t=n.dataset.property;if(!t)return;let i=n.querySelector(".smg-override-type-radio:checked")?.value||"auto";if(i==="auto")return;let r="";if(i==="field")r=n.querySelector(".smg-override-field-select .smg-override-select")?.value||"";else if(i==="custom"){let d=n.querySelector(".smg-override-input"),l=n.querySelector(".smg-override-textarea");r=d?.value||l?.value||""}r&&(s[t]={type:i,value:r})}),e.value=JSON.stringify(s)},async handleOpenPreviewModal(e){e.preventDefault();let s=document.getElementById("smg-preview-modal");if(!s)return;let n=document.querySelector(".smg-meta-box")?.dataset.postId;if(!n)return;let t=s.querySelector(".smg-schema-preview-modal");t&&(t.textContent=typeof smgAdmin<"u"&&smgAdmin.strings?.loading?smgAdmin.strings.loading:"Loading..."),s.style.display="flex",s.offsetHeight,s.classList.add("smg-modal-open"),document.body.style.overflow="hidden";try{let o=await this.fetchPreview(n);o.success&&t&&(t.textContent=o.data.json,o.data.validation&&this.showValidation(o.data.validation))}catch(o){console.error("Failed to load preview:",o),t&&(t.textContent="Failed to load preview")}},closePreviewModal(){let e=document.getElementById("smg-preview-modal");!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")},handleSelectLogo(e){e.preventDefault(),this.logoMediaFrame||(this.logoMediaFrame=wp.media({title:typeof smgAdmin<"u"&&smgAdmin.strings?.selectLogo?smgAdmin.strings.selectLogo:"Select Organization Logo",button:{text:typeof smgAdmin<"u"&&smgAdmin.strings?.useLogo?smgAdmin.strings.useLogo:"Use this logo"},library:{type:"image"},multiple:!1}),this.logoMediaFrame.on("select",()=>{let s=this.logoMediaFrame.state().get("selection").first().toJSON();this.updateLogoPreview(s)})),this.logoMediaFrame.open()},handleRemoveLogo(e){e.preventDefault();let s=document.getElementById("smg-logo-preview"),a=document.getElementById("smg-organization-logo"),n=document.getElementById("smg-remove-logo");s&&(s.innerHTML='<span class="smg-no-image text-gray-400">'+(typeof smgAdmin<"u"&&smgAdmin.strings?.noLogo?smgAdmin.strings.noLogo:"No logo set")+"</span>"),a&&(a.value=""),n&&n.classList.add("hidden"),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.logoRemoved?smgAdmin.strings.logoRemoved:"Logo removed. Save settings to apply.","info")},updateLogoPreview(e){let s=document.getElementById("smg-logo-preview"),a=document.getElementById("smg-organization-logo"),n=document.getElementById("smg-remove-logo");if(s&&e.url){let t=e.sizes?.thumbnail?.url||e.url;s.innerHTML=`<img src="${t}" alt="" class="max-h-16 rounded border border-gray-200">`}a&&(a.value=e.id),n&&n.classList.remove("hidden"),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.logoSelected?smgAdmin.strings.logoSelected:"Logo selected. Save settings to apply.","success")},showToast(e,s="info"){let a=document.createElement("div");a.className=`smg-toast smg-toast-${s} smg-animate-slide-in-right`,a.innerHTML=`
                <span class="dashicons dashicons-${s==="success"?"yes-alt":s==="error"?"warning":"info"}"></span>
                ${e}
            `;let n=document.querySelector(".smg-toast-container");n||(n=document.createElement("div"),n.className="smg-toast-container",n.style.cssText="position: fixed; top: 50px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;",document.body.appendChild(n)),n.appendChild(a),setTimeout(()=>{a.style.opacity="0",a.style.transform="translateX(20px)",setTimeout(()=>a.remove(),300)},this.config.toastDuration)},debounce(e,s){let a;return function(...t){let o=()=>{clearTimeout(a),e(...t)};clearTimeout(a),a=setTimeout(o,s)}},handleOpenIntegrationModal(e){e.preventDefault();let a=e.target.closest(".smg-open-integration-modal")?.dataset.integration;if(!a)return;let n=document.getElementById(`smg-integration-modal-${a}`);n&&(n.style.display="flex",n.offsetHeight,n.classList.add("smg-modal-open"),document.body.style.overflow="hidden")},closeIntegrationModal(e){!e||e.style.display==="none"||(e.classList.remove("smg-modal-open"),setTimeout(()=>{e.style.display="none"},this.config.animationDuration),document.body.style.overflow="")},async handleIntegrationSettingChange(e){let s=e.name.match(/smg_integrations_settings\[([^\]]+)\]/);if(!s)return;let a=s[1],n;if(e.name.endsWith("[]")){let o=document.querySelectorAll(`input[name="${e.name}"]`);n=Array.from(o).filter(i=>i.checked).map(i=>i.value)}else n=e.checked?"1":"0";let t=e.closest(".smg-modal-section, .smg-toggle, label");t&&t.classList.add("smg-saving");try{await this.saveIntegrationSetting(a,n),t&&(t.classList.remove("smg-saving"),t.classList.add("smg-saved"),setTimeout(()=>{t.classList.remove("smg-saved")},1500)),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saved?smgAdmin.strings.saved:"Saved","success"),a.startsWith("integration_")&&a.endsWith("_enabled")&&this.updateIntegrationCardStatus(a,e.checked)}catch(o){console.error("Failed to save integration setting:",o),t&&t.classList.remove("smg-saving"),this.showToast(typeof smgAdmin<"u"&&smgAdmin.strings?.saveFailed?smgAdmin.strings.saveFailed:"Failed to save","error")}},saveIntegrationSetting(e,s){return new Promise((a,n)=>{let t=new FormData;t.append("action","smg_save_integration_setting"),t.append("nonce",typeof smgAdmin<"u"?smgAdmin.nonce:""),t.append("setting_key",e),Array.isArray(s)?(s.forEach(o=>{t.append("setting_value[]",o)}),s.length===0&&t.append("setting_value","")):t.append("setting_value",s),fetch(typeof smgAdmin<"u"?smgAdmin.ajaxUrl:ajaxurl,{method:"POST",body:t,credentials:"same-origin"}).then(o=>o.json()).then(o=>{o.success?a(o):n(new Error(o.data?.message||"Save failed"))}).catch(o=>n(o))})},updateIntegrationCardStatus(e,s){let a=e.match(/^integration_(.+)_enabled$/);if(!a)return;let n=a[1],t=document.querySelector(`.smg-integration-card .smg-open-integration-modal[data-integration="${n}"]`)?.closest(".smg-integration-card");if(t)if(s){t.classList.remove("detected"),t.classList.add("active");let o=t.querySelector(".smg-status-badge");o&&(o.className="smg-status-badge active",o.innerHTML='<span class="dashicons dashicons-yes-alt"></span> Active')}else{t.classList.remove("active"),t.classList.add("detected");let o=t.querySelector(".smg-status-badge");o&&(o.className="smg-status-badge detected",o.innerHTML='<span class="dashicons dashicons-visibility"></span> Detected')}},async handleCalculateCourseDurations(e){e.preventDefault();let s=document.getElementById("smg-calculate-durations-btn"),a=document.getElementById("smg-duration-progress"),n=document.getElementById("smg-duration-progress-bar"),t=document.getElementById("smg-duration-status"),o=document.getElementById("smg-duration-results"),i=document.getElementById("smg-duration-results-list");if(!s||!a||!o)return;s.classList.add("hidden"),a.classList.remove("hidden"),o.classList.add("hidden"),n.style.width="5%";let r=a.querySelector(".smg-spinner");r&&r.classList.remove("hidden");let d=[{percent:5,message:"Loading MemberPress courses..."},{percent:15,message:"Scanning course structure..."},{percent:25,message:"Reading lesson content..."},{percent:40,message:"Searching for embedded YouTube videos..."},{percent:55,message:"Searching for embedded Vimeo videos..."},{percent:65,message:"Extracting video IDs..."},{percent:75,message:"Fetching durations from YouTube API..."},{percent:85,message:"Calculating total course durations..."},{percent:90,message:"Saving duration metadata..."}],l=0;t.textContent=d[0].message;try{let c=setInterval(()=>{if(l<d.length-1){l++;let p=d[l];n.style.width=p.percent+"%",t.textContent=p.message}},800),m=await fetch(smgAdmin.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"smg_calculate_course_durations",nonce:smgAdmin.nonce})});clearInterval(c),n.style.width="100%";let h=a.querySelector(".smg-spinner");h&&h.classList.add("hidden");let g=await m.json();if(g.data?.debug&&(console.group("SMG Course Duration Debug"),console.log("Debug info for first courses:",g.data.debug),g.data.debug.forEach(p=>{console.group(`Course: ${p.course_title}`),console.log(`Total lessons: ${p.total_lessons}, With video: ${p.lessons_with_video}`),p.lessons?.forEach(u=>{console.log(`Lesson: ${u.title}`,{content_length:u.content_length,has_youtube_text:u.has_youtube_text,youtube_url_found:u.youtube_url_found,duration:u.duration_seconds,content_preview:u.content_preview})}),console.groupEnd()}),console.groupEnd()),g.success){a.classList.add("hidden");let p=`
                        <div class="smg-duration-success-message">
                            <span class="dashicons dashicons-yes-alt" style="color: var(--smg-success);"></span>
                            ${g.data.message}
                        </div>
                    `;g.data.courses&&g.data.courses.length>0?(g.data.courses.forEach(u=>{let f=u.has_video?"has-video":"";p+=`
                                <div class="smg-duration-result-item ${f}">
                                    <span class="smg-duration-result-title">${this.escapeHtml(u.title)}</span>
                                    <span class="smg-duration-result-meta">
                                        <span class="smg-duration-result-lessons">${u.lessons} lessons</span>
                                        <span class="smg-duration-result-time">${u.duration_formatted}</span>
                                    </span>
                                </div>
                            `}),p+=`
                            <div class="smg-duration-summary">
                                <span class="smg-duration-summary-label">
                                    ${g.data.courses_with_video}/${g.data.total_courses} courses with video
                                </span>
                                <span class="smg-duration-summary-value">
                                    Total: ${g.data.total_duration}
                                </span>
                            </div>
                        `):p+='<p class="smg-text-muted text-sm">'+(smgAdmin?.i18n?.no_courses||"No courses found.")+"</p>",i.innerHTML=p,o.classList.remove("hidden"),s.classList.remove("hidden")}else t.innerHTML='<span class="dashicons dashicons-warning" style="color: var(--smg-error);"></span> '+(g.data?.message||"Error calculating durations."),s.classList.remove("hidden")}catch(c){console.error("Error calculating durations:",c),t.innerHTML='<span class="dashicons dashicons-warning" style="color: var(--smg-error);"></span> '+(smgAdmin?.i18n?.error||"An error occurred."),s.classList.remove("hidden")}},async handleSaveYouTubeApiKey(e){e.preventDefault();let s=e.target.closest("#smg-save-youtube-api"),a=document.getElementById("smg-youtube-api-key-input"),n=document.getElementById("smg-youtube-api-result"),t=a?.value?.trim();if(!t){this.showYouTubeResult(n,!1,"Please enter an API key.");return}s.disabled=!0,s.innerHTML='<span class="smg-spinner"></span> Verifying...';try{let i=await(await fetch(smgAdmin.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"smg_save_youtube_api_key",nonce:smgAdmin.nonce,api_key:t})})).json();i.success?(this.showYouTubeResult(n,!0,i.data.message),setTimeout(()=>window.location.reload(),1500)):this.showYouTubeResult(n,!1,i.data?.message||"Failed to save API key.")}catch(o){console.error("YouTube API save error:",o),this.showYouTubeResult(n,!1,"An error occurred. Please try again.")}s.disabled=!1,s.innerHTML='<span class="dashicons dashicons-saved"></span> Save & Test'},async handleTestYouTubeApiKey(e){e.preventDefault();let s=e.target.closest("#smg-test-youtube-api");s.disabled=!0,s.innerHTML='<span class="smg-spinner"></span> Testing...';try{let n=await(await fetch(smgAdmin.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"smg_test_youtube_api_key",nonce:smgAdmin.nonce})})).json();n.success?alert("\u2705 "+n.data.message):alert("\u274C "+(n.data?.message||"API key test failed."))}catch(a){console.error("YouTube API test error:",a),alert("\u274C An error occurred while testing the API key.")}s.disabled=!1,s.innerHTML='<span class="dashicons dashicons-yes"></span> Test API Key'},async handleRemoveYouTubeApiKey(e){if(e.preventDefault(),!confirm("Are you sure you want to remove the YouTube API key?"))return;let s=e.target.closest("#smg-remove-youtube-api");s.disabled=!0,s.innerHTML='<span class="smg-spinner"></span> Removing...';try{let n=await(await fetch(smgAdmin.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"smg_remove_youtube_api_key",nonce:smgAdmin.nonce})})).json();n.success?(alert("\u2705 "+n.data.message),window.location.reload()):alert("\u274C "+(n.data?.message||"Failed to remove API key."))}catch(a){console.error("YouTube API remove error:",a),alert("\u274C An error occurred while removing the API key.")}s.disabled=!1,s.innerHTML='<span class="dashicons dashicons-trash"></span> Remove'},handleChangeYouTubeApiKey(e){e.preventDefault();let s=document.getElementById("smg-youtube-api-form");s&&s.classList.remove("hidden")},showYouTubeResult(e,s,a){e&&(e.classList.remove("hidden"),e.className=`mt-3 p-3 rounded-lg text-sm ${s?"bg-emerald-50 text-emerald-800 border border-emerald-200":"bg-red-50 text-red-800 border border-red-200"}`,e.innerHTML=`
                <span class="dashicons ${s?"dashicons-yes-alt":"dashicons-warning"}" style="color: ${s?"var(--smg-success)":"var(--smg-error)"};"></span>
                ${this.escapeHtml(a)}
            `)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>y.init()):y.init(),window.SMGAdmin=y})();})();
